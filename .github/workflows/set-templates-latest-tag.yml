name: Set app-template latest tag which is used in installer to locate the default template version

on:
  workflow_call:
  workflow_dispatch:

jobs:
  reset-latest-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set @loopstack/app-template latest tag
        run: |
          # Find all @loopstack/app-template@x.x.x tags and get the latest one
          LATEST_VERSION_TAG=$(git tag -l '@loopstack/app-template@*' | grep -E '@loopstack/app-template@[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)

          if [ -z "$LATEST_VERSION_TAG" ]; then
            echo "❌ No @loopstack/app-template version tags found"
            exit 1
          fi

          echo "Found latest version tag: $LATEST_VERSION_TAG"

          # Get the commit SHA for this tag
          COMMIT_SHA=$(git rev-list -n 1 "$LATEST_VERSION_TAG")
          echo "Commit SHA: $COMMIT_SHA"

          LATEST_TAG="@loopstack/app-template@latest"

          # Check if latest tag exists
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            CURRENT_SHA=$(git rev-list -n 1 "$LATEST_TAG")
            echo "Current $LATEST_TAG points to: $CURRENT_SHA"
          
            if [ "$CURRENT_SHA" = "$COMMIT_SHA" ]; then
              echo "✅ $LATEST_TAG already points to $LATEST_VERSION_TAG"
              exit 0
            fi
          
            echo "Deleting existing $LATEST_TAG"
            git tag -d "$LATEST_TAG"
            git push origin --delete "$LATEST_TAG"
          fi

          # Create new latest tag pointing to the same commit
          echo "Creating $LATEST_TAG pointing to $LATEST_VERSION_TAG ($COMMIT_SHA)"
          git tag "$LATEST_TAG" "$COMMIT_SHA"
          git push origin "$LATEST_TAG"
          echo "✅ Successfully reset $LATEST_TAG to $LATEST_VERSION_TAG"
