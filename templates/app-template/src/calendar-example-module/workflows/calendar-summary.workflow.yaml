title: 'Calendar Summary'

description: |
  Fetches upcoming events from Google Calendar and displays a summary.
  If not authenticated, prompts the user to authenticate via the
  Google OAuth workflow and retry.

ui:
  form:
    properties:
      calendarId:
        title: 'Calendar ID'
        placeholder: 'primary'

transitions:
  # Fetch events from Google Calendar
  - id: fetch_events
    from: start
    to: calendar_fetched
    call:
      - tool: googleCalendarFetchEvents
        id: calendar_fetch
        args:
          calendarId: ${{ args.calendarId }}
          timeMin: ${{ now() }}
          timeMax: ${{ endOfWeek() }}
        assign:
          requiresAuthentication: ${{ result.data.error == "unauthorized" }}
          events: ${{ result.data.events }}

  # If unauthorized → show auth-required document with retry button
  - id: auth_required
    from: calendar_fetched
    to: awaiting_retry
    if: ${{ state.requiresAuthentication }}
    call:
      - tool: createDocument
        args:
          id: authStatus
          document: authRequiredDocument
          update:
            content:
              provider: google
              message: 'Google authentication required to access your calendar. Please authenticate and then click Retry.'
              workflowName: googleOAuth
              workspaceId: ${{ context.workspaceId }}
              scopes:
                - 'https://www.googleapis.com/auth/calendar.readonly'

  # User clicks Retry after authenticating in the separate workflow
  - id: retry
    from: awaiting_retry
    to: start
    trigger: manual
    call:
      - tool: createDocument
        args:
          id: authStatus
          document: linkDocument
          update:
            content:
              icon: 'ShieldCheck'
              type: 'success'
              label: 'Google authentication completed'
              caption: 'Google authentication required to access your calendar. Please authenticate and then click Retry.'
              href: '/pipelines/{{ runtime.transition.payload.pipelineId }}'

  # Success → store events and display summary
  - id: display_results
    from: calendar_fetched
    to: end
    call:
      - tool: createChatMessage
        args:
          role: assistant
          content: |
            Here are your upcoming events:

            {{#each state.events}}
            - **{{ this.summary }}** — {{ this.start }} to {{ this.end }}
            {{/each}}

            {{#unless state.events}}
            No upcoming events found.
            {{/unless}}
