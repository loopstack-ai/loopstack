title: 'Outlook Calendar'

description: |
  Fetches upcoming events from Outlook Calendar and displays a summary.
  If not authenticated, prompts the user to authenticate via Microsoft OAuth and retry.

transitions:
  - id: fetch_events
    from: start
    to: events_fetched
    call:
      - tool: outlookFetchEvents
        id: outlook_fetch
        args:
          timeMin: ${{ now() }}
          timeMax: ${{ endOfWeek() }}
        assign:
          requiresAuthentication: ${{ result.data.error == "unauthorized" }}
          events: ${{ result.data.events }}

  - id: auth_required
    from: events_fetched
    to: awaiting_retry
    if: ${{ state.requiresAuthentication }}
    call:
      - tool: createDocument
        args:
          id: authStatus
          document: authRequiredDocument
          update:
            content:
              provider: microsoft
              message: 'Microsoft authentication required to access your Outlook calendar. Please authenticate and then click Retry.'
              workflowName: oauth
              workspaceId: ${{ context.workspaceId }}
              scopes:
                - 'openid'
                - 'profile'
                - 'offline_access'
                - 'Calendars.Read'

  - id: retry
    from: awaiting_retry
    to: start
    trigger: manual
    call:
      - tool: createDocument
        args:
          id: authStatus
          document: linkDocument
          update:
            content:
              icon: 'ShieldCheck'
              type: 'success'
              label: 'Microsoft authentication completed'
              caption: 'You can now access your Outlook calendar.'
              href: '/pipelines/{{ runtime.transition.payload.pipelineId }}'

  - id: display_results
    from: events_fetched
    to: end
    call:
      - tool: createDocument
        args:
          document: markdown
          update:
            content:
              markdown: |
                Here are your upcoming Outlook events:

                {{#each state.events}}
                - **{{ this.summary }}** â€” {{ this.start }} to {{ this.end }}
                {{/each}}

                {{#unless state.events}}
                No upcoming events found.
                {{/unless}}
